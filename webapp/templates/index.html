<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>X Bot Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <main class="container">
      <h1>X Bot Local Dashboard</h1>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="alerts">
            {% for category, msg in messages %}
              <div class="alert {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <section class="card">
        <h2>Home / Status</h2>
        <div class="grid two">
          <div>
            <p><strong>DRY_RUN:</strong> {{ 'true' if dry_run else 'false' }}</p>
            <p><strong>DB Path:</strong> <code>{{ db_path }}</code></p>
            <p><strong>Posts count:</strong> {{ stats.posts_count }}</p>
            <p><strong>Errors count:</strong> {{ stats.errors_count }} <small>(source: {{ stats.error_source }})</small></p>
          </div>
          <div>
            <p><strong>Current masked env:</strong></p>
            <ul>
              {% for key in ['X_API_KEY','X_API_SECRET','X_API_KEY_SECRET','X_ACCESS_TOKEN','X_ACCESS_TOKEN_SECRET'] %}
                <li><code>{{ key }}</code> = <code>{{ env_masked.get(key, '') }}</code></li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>.env Editor</h2>
        <form method="post" action="{{ url_for('save_env') }}">
          <div class="grid two">
            <label>X_API_KEY
              <input type="password" name="X_API_KEY" placeholder="Enter new value to update" />
            </label>
            <label>X_API_SECRET
              <input type="password" name="X_API_SECRET" placeholder="Enter new value to update" />
            </label>
            <label>X_API_KEY_SECRET (alias)
              <input type="password" name="X_API_KEY_SECRET" placeholder="Optional alias" />
            </label>
            <label>X_ACCESS_TOKEN
              <input type="password" name="X_ACCESS_TOKEN" placeholder="Enter new value to update" />
            </label>
            <label>X_ACCESS_TOKEN_SECRET
              <input type="password" name="X_ACCESS_TOKEN_SECRET" placeholder="Enter new value to update" />
            </label>
            <label class="checkbox">
              <input type="checkbox" name="DRY_RUN" {% if dry_run %}checked{% endif %} />
              DRY_RUN
            </label>
          </div>
          <button type="submit">Save .env</button>
        </form>
        <p class="help">Security: secret values are masked in display. Empty input keeps existing value.</p>
      </section>

      <section class="card">
        <h2>Manual Run</h2>
        <div class="run-buttons">
          <form method="post" action="{{ url_for('run_manual') }}"><input type="hidden" name="slot" value="1" /><button>Run slot1</button></form>
          <form method="post" action="{{ url_for('run_manual') }}"><input type="hidden" name="slot" value="2" /><button>Run slot2</button></form>
          <form method="post" action="{{ url_for('run_manual') }}"><input type="hidden" name="slot" value="3" /><button>Run slot3</button></form>
          <form method="post" action="{{ url_for('run_manual') }}"><input type="hidden" name="slot" value="auto" /><button>Run auto slot</button></form>
        </div>
        {% if run_output %}
          <pre class="output">{{ run_output }}</pre>
        {% endif %}
      </section>

      <section class="card">
        <h2>Config Editor</h2>
        <div class="tabs">
          {% for name, content in configs.items() %}
            <details {% if loop.first %}open{% endif %}>
              <summary>config/{{ name }}.json</summary>
              <form method="post" action="{{ url_for('save_config', name=name) }}">
                <textarea name="content" rows="16">{{ content }}</textarea>
                <button type="submit">Save {{ name }}.json</button>
              </form>
            </details>
          {% endfor %}
        </div>
      </section>

      <section class="card">
        <h2>Recent Logs (tail)</h2>
        {% if logs %}
          {% for log in logs %}
            <details>
              <summary>{{ log.name }}</summary>
              <pre>{{ log.content }}</pre>
            </details>
          {% endfor %}
        {% else %}
          <p>No log files in <code>logs/*.log</code>.</p>
        {% endif %}
      </section>

      <section class="card">
        <h2>Recent Posts (SQLite)</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>posted_at</th>
                <th>slot</th>
                <th>topic</th>
                <th>person</th>
                <th>tweet_id</th>
                <th>article_url</th>
              </tr>
            </thead>
            <tbody>
              {% for row in stats.recent_posts %}
                <tr>
                  <td>{{ row['id'] }}</td>
                  <td>{{ row['posted_at'] }}</td>
                  <td>{{ row['slot'] }}</td>
                  <td>{{ row['topic'] or '' }}</td>
                  <td>{{ row['person'] or '' }}</td>
                  <td>{{ row['tweet_id'] or '' }}</td>
                  <td><a href="{{ row['article_url'] }}" target="_blank" rel="noreferrer">link</a></td>
                </tr>
              {% else %}
                <tr><td colspan="7">No posts yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

    </main>
  </body>
</html>
